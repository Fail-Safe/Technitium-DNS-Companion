services:
  technitium-dns-companion:
    # Production default: pull the published image.
    # If you want to build locally instead, comment out `image:` and uncomment `build:`.
    image: ghcr.io/fail-safe/technitium-dns-companion:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: technitium-dns-companion
    restart: unless-stopped

    ports:
      # HTTP (default)
      - "3000:3000"
      # HTTPS (if enabled)
      - "3443:3443"

    environment:
      # Node environment
      NODE_ENV: production

      # Server configuration
      PORT: 3000
      HTTPS_ENABLED: "false" # Set to "true" to enable HTTPS
      # HTTPS_PORT: 3443
      # HTTPS_CERT_PATH: /app/certs/fullchain.pem
      # HTTPS_KEY_PATH: /app/certs/privkey.pem
      # HTTPS_CA_PATH: /app/certs/chain.pem  # Optional

      # Authentication (as of v1.2.1)
      #
      # Preferred: Technitium-backed session authentication
      # - Users log in with their Technitium credentials via the Companion UI
      # - Companion stores Technitium session tokens server-side; browser uses an HttpOnly cookie
      # - App is expected to be usable only after login (v1.3 direction)
      #
      # IMPORTANT: Run over HTTPS when enabling session auth.
      # - Option A: enable Companion HTTPS above and mount certs below
      # - Option B: terminate TLS in a reverse proxy and set TRUST_PROXY=true
      #
      # v1.2.x only (migration/stop-gap):
      # AUTH_SESSION_ENABLED: "true"
      # v1.3+: planned to be removed (session auth always enabled)
      # TRUST_PROXY: "true"
      # TRUST_PROXY_HOPS: "1"

      # Timezone
      TZ: America/New_York

      # CORS (optional, for development)
      # CORS_ORIGINS: http://localhost:5173,http://localhost:3000

      # Technitium DNS Nodes Configuration
      # List of node IDs (comma-separated)
      TECHNITIUM_NODES: node1,node2

      # Legacy env-token mode (still supported)
      #
      # In session-auth deployments, TECHNITIUM_*_TOKEN / TECHNITIUM_CLUSTER_TOKEN are OPTIONAL.
      # If you leave tokens blank, API calls require a logged-in user session.
      #
      # Cluster token (legacy env-token mode)
      # DEPRECATION NOTE: As of v1.3, TECHNITIUM_CLUSTER_TOKEN is planned to be deprecated.
      # Planned removal: v1.4.
      # Prefer Technitium-backed login sessions (interactive) + TECHNITIUM_BACKGROUND_TOKEN (background).
      TECHNITIUM_CLUSTER_TOKEN: ${TECHNITIUM_CLUSTER_TOKEN:-}

      # Node 1 Configuration
      TECHNITIUM_NODE1_NAME: "DNS Primary"
      TECHNITIUM_NODE1_BASE_URL: https://dns-primary.example.com:53443

      # Node 2 Configuration
      TECHNITIUM_NODE2_NAME: "DNS Secondary"
      TECHNITIUM_NODE2_BASE_URL: https://dns-secondary.example.com:53443

      # Legacy per-node tokens (optional - only if not using TECHNITIUM_CLUSTER_TOKEN)
      # TECHNITIUM_NODE1_TOKEN: ${TECHNITIUM_NODE1_TOKEN:-}
      # TECHNITIUM_NODE2_TOKEN: ${TECHNITIUM_NODE2_TOKEN:-}

      # Optional: Background token (read-only) for background jobs when session auth is enabled
      # If unset, background jobs that require a token may be disabled.
      # NOTE (planned change): As of v1.3, this is expected to be REQUIRED when
      # using session auth if you want background features (PTR warming, scheduled sync) to run.
      # IMPORTANT: Use a low-privilege Technitium user token.
      # TECHNITIUM_BACKGROUND_TOKEN: ${TECHNITIUM_BACKGROUND_TOKEN:-}

    # Optional bind mounts (uncomment as needed)
    # volumes:
    #   # Mount SSL certificates (if using HTTPS)
    #   - ./certs:/app/certs:ro
    #
    #   # Optional: Mount config directory
    #   - ./config:/app/config
    volumes: []

    networks:
      - technitium-dns-companion-network

    # Resource limits (optional)
    #
    # IMPORTANT (non-Swarm deployments):
    # - The `deploy:` section is primarily for Docker Swarm.
    # - With plain `docker compose up` (non-Swarm), these limits are typically NOT enforced.
    # - If you want `deploy.resources` to be applied in non-Swarm compose, start with:
    #     docker compose --compatibility up -d
    #
    # Sizing note:
    # - Production should use less memory than the dev container (no Vite/HMR).
    # - However, large blocklists / domain-list caching can legitimately increase baseline RAM.
    # - If you enforce a hard limit that is too low, the Node process may be OOM-killed.
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  technitium-dns-companion-network:
    driver: bridge
